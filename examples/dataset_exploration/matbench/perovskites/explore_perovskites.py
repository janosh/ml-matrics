# %%
import matplotlib.pyplot as plt
from matminer.datasets import load_dataset
from tqdm import tqdm

from pymatviz import plot_structure_2d, ptable_heatmap, spacegroup_sunburst
from pymatviz.enums import Key
from pymatviz.powerups import annotate_bars
from pymatviz.utils import crystal_sys_from_spg_num


"""Stats for the matbench_perovskites dataset.

Input: Pymatgen Structure of the material.
Target variable: Heat of formation of the entire 5-atom perovskite cell in eV
    as calculated by RPBE GGA-DFT. Note the reference state for oxygen was
    computed from oxygen's chemical potential in water vapor, not as oxygen
    molecules, to reflect the application which these perovskites were studied for.
Entries: 18,928

Matbench v0.1 dataset for predicting formation energy from crystal structure.
Adapted from an original dataset generated by Castelli et al.

https://ml.materialsproject.org/projects/matbench_perovskites
"""

# %%
df_perov = load_dataset("matbench_perovskites")

df_perov[[Key.spacegroup_symbol, Key.spacegroup]] = [
    struct.get_space_group_info() for struct in tqdm(df_perov[Key.structure])
]
df_perov[Key.volume] = df_perov[Key.structure].map(lambda struct: struct.volume)

df_perov[Key.formula] = df_perov[Key.structure].map(lambda cryst: cryst.formula)

df_perov[Key.crystal_system] = [
    crystal_sys_from_spg_num(x) for x in df_perov[Key.spacegroup]
]


# %%
n_rows, n_cols = 3, 4
fig, axs = plt.subplots(n_rows, n_cols, figsize=(3 * n_cols, 3 * n_rows))

for struct, ax in zip(df_perov[Key.structure], axs.flat):
    plot_structure_2d(struct, ax=ax)
    ax.set_title(struct.formula, fontsize=14)

plt.savefig("perovskite-structures-2d.pdf")


# %%
df_perov.hist(column="e_form", bins=50)
plt.savefig("perovskites-e_form-hist.pdf")


# %%
ax = ptable_heatmap(df_perov.formula, log=True)
plt.title("Elements in Matbench Perovskites dataset")
plt.savefig("perovskites-ptable-heatmap.pdf")


# %%
df_perov[Key.crystal_system].value_counts().plot.bar()

plt.title("Crystal systems in Matbench Perovskites")
plt.xticks(rotation="horizontal")

annotate_bars(v_offset=250)

plt.savefig("perovskites-crystal-system-counts.pdf")


# %%
df_perov.plot.scatter(x=Key.volume, y="e_form", c=Key.spacegroup, colormap="viridis")


# %%
fig = spacegroup_sunburst(df_perov[Key.spacegroup], show_counts="percent")
fig.update_layout(title="Matbench Perovskites spacegroup sunburst")
fig.write_image("perovskite-spacegroup-sunburst.pdf")
fig.show()
